<div class="max-w-7xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <div class="flex justify-between items-start">
    <div class="flex items-center">
      <%= link_to crm_contacts_path, class: "text-text-secondary hover:text-primary mr-4" do %>
        <i class="icon-arrow-left text-lg"></i>
      <% end %>
      <div>
        <h1 class="text-3xl font-bold text-heading flex items-center">
          <%= @contact.display_name %>
          <span class="ml-3 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                       <%= lifecycle_stage_color(@contact.lifecycle_stage) %>">
            <%= @contact.lifecycle_stage.humanize %>
          </span>
        </h1>
        <p class="text-text-secondary mt-1">
          <i class="icon-mail mr-1"></i><%= @contact.email %>
          <% if @contact.phone.present? %>
            <span class="mx-2">•</span>
            <i class="icon-phone mr-1"></i><%= @contact.phone %>
          <% end %>
        </p>
      </div>
    </div>
    <div class="flex space-x-3">
      <%= link_to edit_crm_contact_path(@contact), class: "btn-secondary" do %>
        <i class="icon-edit mr-2"></i>
        Edit Contact
      <% end %>
      <%= link_to crm_contact_path(@contact), method: :delete, 
            class: "btn-danger", 
            data: { confirm: "Are you sure you want to delete this contact?" } do %>
        <i class="icon-trash mr-2"></i>
        Delete
      <% end %>
    </div>
  </div>

  <!-- Contact Metrics -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="card p-4">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-primary/10">
          <i class="icon-star text-primary text-xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm text-text-secondary">Contact Score</p>
          <div class="flex items-center">
            <div class="flex-1 bg-surface-secondary rounded-full h-2 mr-2">
              <div class="h-full rounded-full transition-all duration-300
                         <%= @contact.contact_score >= 70 ? 'bg-success' : @contact.contact_score >= 40 ? 'bg-warning' : 'bg-error' %>"
                   style="width: <%= @contact.contact_score %>%"></div>
            </div>
            <span class="text-lg font-bold text-heading"><%= @contact.contact_score %></span>
          </div>
        </div>
      </div>
    </div>

    <div class="card p-4">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-success/10">
          <i class="icon-dollar-sign text-success text-xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm text-text-secondary">Total Deal Value</p>
          <p class="text-2xl font-bold text-heading">$<%= number_with_delimiter(@total_deal_value) %></p>
        </div>
      </div>
    </div>

    <div class="card p-4">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-info/10">
          <i class="icon-briefcase text-info text-xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm text-text-secondary">Active Deals</p>
          <p class="text-2xl font-bold text-heading"><%= @active_deals_count %></p>
        </div>
      </div>
    </div>

    <div class="card p-4">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-warning/10">
          <i class="icon-clock text-warning text-xl"></i>
        </div>
        <div class="ml-4">
          <p class="text-sm text-text-secondary">Days Since Contact</p>
          <p class="text-2xl font-bold text-heading"><%= @days_since_last_contact %></p>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Contact Information -->
    <div class="lg:col-span-1">
      <div class="card p-6">
        <h3 class="text-lg font-semibold text-heading mb-4">Contact Information</h3>
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium text-text-secondary">Full Name</label>
            <p class="text-heading"><%= @contact.full_name %></p>
          </div>
          
          <% if @contact.company.present? %>
            <div>
              <label class="text-sm font-medium text-text-secondary">Company</label>
              <p class="text-heading"><%= @contact.company %></p>
            </div>
          <% end %>
          
          <% if @contact.job_title.present? %>
            <div>
              <label class="text-sm font-medium text-text-secondary">Job Title</label>
              <p class="text-heading"><%= @contact.job_title %></p>
            </div>
          <% end %>
          
          <div>
            <label class="text-sm font-medium text-text-secondary">Email</label>
            <p class="text-heading">
              <a href="mailto:<%= @contact.email %>" class="text-primary hover:underline">
                <%= @contact.email %>
              </a>
            </p>
          </div>
          
          <% if @contact.phone.present? %>
            <div>
              <label class="text-sm font-medium text-text-secondary">Phone</label>
              <p class="text-heading">
                <a href="tel:<%= @contact.phone %>" class="text-primary hover:underline">
                  <%= @contact.phone %>
                </a>
              </p>
            </div>
          <% end %>
          
          <% if @contact.website.present? %>
            <div>
              <label class="text-sm font-medium text-text-secondary">Website</label>
              <p class="text-heading">
                <a href="<%= @contact.website %>" target="_blank" class="text-primary hover:underline">
                  <%= @contact.website %>
                </a>
              </p>
            </div>
          <% end %>
          
          <% if [@contact.address, @contact.city, @contact.state].any?(&:present?) %>
            <div>
              <label class="text-sm font-medium text-text-secondary">Address</label>
              <p class="text-heading">
                <%= [@contact.address, @contact.city, @contact.state, @contact.postal_code].compact.join(', ') %>
              </p>
            </div>
          <% end %>
          
          <% if @contact.source.present? %>
            <div>
              <label class="text-sm font-medium text-text-secondary">Source</label>
              <p class="text-heading"><%= @contact.source %></p>
            </div>
          <% end %>
          
          <% if @contact.description.present? %>
            <div>
              <label class="text-sm font-medium text-text-secondary">Description</label>
              <p class="text-heading"><%= @contact.description %></p>
            </div>
          <% end %>
          
          <div>
            <label class="text-sm font-medium text-text-secondary">Created</label>
            <p class="text-heading"><%= @contact.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card p-6 mt-6">
        <h3 class="text-lg font-semibold text-heading mb-4">Quick Actions</h3>
        <div class="space-y-3">
          <!-- Create Deal -->
          <%= form_with url: create_deal_crm_contact_path(@contact), method: :post, local: true, class: "border border-border rounded-lg p-4" do |form| %>
            <h4 class="font-medium text-heading mb-2">Create New Deal</h4>
            <div class="space-y-2">
              <%= form.text_field :deal_name, placeholder: "Deal name", class: "input-field text-sm" %>
              <div class="grid grid-cols-2 gap-2">
                <%= form.number_field :amount, placeholder: "Amount", step: 0.01, class: "input-field text-sm" %>
                <%= form.date_field :expected_close_date, class: "input-field text-sm" %>
              </div>
              <%= form.submit "Create Deal", class: "btn-primary w-full text-sm" %>
            </div>
          <% end %>

          <!-- Log Activity -->
          <%= form_with url: create_activity_crm_contact_path(@contact), method: :post, local: true, class: "border border-border rounded-lg p-4" do |form| %>
            <h4 class="font-medium text-heading mb-2">Log Activity</h4>
            <div class="space-y-2">
              <%= form.select :activity_type, [
                    ['Call', 'call'],
                    ['Email', 'email'],
                    ['Meeting', 'meeting'],
                    ['Note', 'note'],
                    ['Other', 'other']
                  ], {}, { class: "input-field text-sm" } %>
              <%= form.text_field :subject, placeholder: "Activity subject", class: "input-field text-sm" %>
              <%= form.text_area :description, placeholder: "Description", rows: 2, class: "input-field text-sm" %>
              <%= form.datetime_local_field :activity_date, value: Time.current.strftime("%Y-%m-%dT%H:%M"), class: "input-field text-sm" %>
              <%= form.submit "Log Activity", class: "btn-secondary w-full text-sm" %>
            </div>
          <% end %>

          <!-- Add Note -->
          <%= form_with url: create_note_crm_contact_path(@contact), method: :post, local: true, class: "border border-border rounded-lg p-4" do |form| %>
            <h4 class="font-medium text-heading mb-2">Add Note</h4>
            <div class="space-y-2">
              <%= form.text_area :note_content, placeholder: "Add a note about this contact...", rows: 3, class: "input-field text-sm" %>
              <%= form.submit "Add Note", class: "btn-accent w-full text-sm" %>
            </div>
          <% end %>

          <!-- Create Task -->
          <%= form_with url: create_task_crm_contact_path(@contact), method: :post, local: true, class: "border border-border rounded-lg p-4" do |form| %>
            <h4 class="font-medium text-heading mb-2">Create Task</h4>
            <div class="space-y-2">
              <%= form.text_field :task_title, placeholder: "Task title", class: "input-field text-sm" %>
              <%= form.text_area :task_description, placeholder: "Task description", rows: 2, class: "input-field text-sm" %>
              <div class="grid grid-cols-2 gap-2">
                <%= form.date_field :task_due_date, class: "input-field text-sm" %>
                <%= form.select :task_priority, [
                      ['High', 'high'],
                      ['Medium', 'medium'],
                      ['Low', 'low']
                    ], {}, { class: "input-field text-sm" } %>
              </div>
              <%= form.submit "Create Task", class: "btn-warning w-full text-sm" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Interaction Timeline and Details -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Active Tasks -->
      <% if @active_tasks.any? %>
        <div class="card p-6">
          <h3 class="text-lg font-semibold text-heading mb-4">Active Tasks</h3>
          <div class="space-y-3">
            <% @active_tasks.each do |task| %>
              <div class="flex items-center justify-between p-3 bg-surface-secondary rounded-lg">
                <div class="flex-1">
                  <h4 class="font-medium text-heading"><%= task.title %></h4>
                  <p class="text-sm text-text-secondary"><%= task.description if task.description.present? %></p>
                  <div class="flex items-center mt-1 text-xs text-text-secondary">
                    <i class="icon-calendar mr-1"></i>
                    Due: <%= task.due_date.strftime("%B %d, %Y") if task.due_date %>
                    <span class="mx-2">•</span>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                 <%= task.priority == 'high' ? 'bg-error/10 text-error' : 
                                     task.priority == 'medium' ? 'bg-warning/10 text-warning' : 'bg-info/10 text-info' %>">
                      <%= task.priority.humanize %> Priority
                    </span>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Recent Notes -->
      <% if @recent_notes.any? %>
        <div class="card p-6">
          <h3 class="text-lg font-semibold text-heading mb-4">Recent Notes</h3>
          <div class="space-y-4">
            <% @recent_notes.each do |note| %>
              <div class="border-l-4 border-accent pl-4">
                <p class="text-heading"><%= simple_format(note.content) %></p>
                <p class="text-sm text-text-secondary mt-2">
                  <i class="icon-user mr-1"></i><%= note.user&.email %>
                  <span class="mx-2">•</span>
                  <i class="icon-clock mr-1"></i><%= time_ago_in_words(note.created_at) %> ago
                </p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Deals -->
      <% if @deals.any? %>
        <div class="card p-6">
          <h3 class="text-lg font-semibold text-heading mb-4">Deals</h3>
          <div class="space-y-3">
            <% @deals.each do |deal| %>
              <div class="flex items-center justify-between p-4 border border-border rounded-lg">
                <div class="flex-1">
                  <h4 class="font-medium text-heading"><%= deal.deal_name %></h4>
                  <div class="flex items-center mt-1 text-sm text-text-secondary">
                    <span class="font-medium text-success">$<%= number_with_delimiter(deal.amount) %></span>
                    <span class="mx-2">•</span>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                 <%= deal_stage_color(deal.stage) %>">
                      <%= deal.stage.humanize %>
                    </span>
                    <% if deal.expected_close_date %>
                      <span class="mx-2">•</span>
                      <i class="icon-calendar mr-1"></i>
                      Expected: <%= deal.expected_close_date.strftime("%b %d, %Y") %>
                    <% end %>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <%= link_to crm_deal_path(deal), class: "text-primary hover:text-primary-dark" do %>
                    <i class="icon-eye"></i>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Interaction Timeline -->
      <div class="card p-6">
        <h3 class="text-lg font-semibold text-heading mb-4">Interaction Timeline</h3>
        <% if @interaction_timeline.any? %>
          <div class="space-y-4">
            <% @interaction_timeline.each do |item| %>
              <div class="flex">
                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
                           <%= case item[:type]
                               when 'activity' then 'bg-primary/10 text-primary'
                               when 'note' then 'bg-accent/10 text-accent'
                               when 'deal' then 'bg-success/10 text-success'
                               when 'task' then 'bg-warning/10 text-warning'
                               else 'bg-surface-secondary text-text-secondary'
                               end %>">
                  <i class="icon-<%= item[:icon] %> text-sm"></i>
                </div>
                <div class="ml-4 min-w-0 flex-1">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-medium text-heading"><%= item[:title] %></h4>
                    <time class="text-xs text-text-secondary">
                      <%= time_ago_in_words(item[:date]) %> ago
                    </time>
                  </div>
                  <p class="text-sm text-text-secondary mt-1"><%= item[:description] %></p>
                  <% if item[:user] %>
                    <p class="text-xs text-text-secondary mt-1">
                      <i class="icon-user mr-1"></i>by <%= item[:user] %>
                    </p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-8">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-surface-secondary flex items-center justify-center">
              <i class="icon-activity text-text-secondary text-2xl"></i>
            </div>
            <h4 class="text-lg font-medium text-heading mb-2">No interactions yet</h4>
            <p class="text-text-secondary">Activities, notes, and other interactions will appear here.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>